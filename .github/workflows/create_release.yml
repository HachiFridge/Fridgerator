name: Create Release

on: workflow_dispatch

permissions:
  contents: write

env:
  FRIDGERATOR_SKIP_DIRTY_CHECK: 1

jobs:
  build-android:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    steps:
      - uses: actions/checkout@v5
      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2

      - name: Setup and Patch Dependencies
        run: |
          pushd ..

          git clone --revision 44cdd653e2317d300fb8a6c9c36b03f23991e803 https://github.com/emilk/egui.git
          cd egui

          sed -i 's/ui.set_min_width(ui.available_width());/\/\/ ui.set_min_width(ui.available_width());/' crates/egui/src/containers/combo_box.rs

          popd

          echo 'egui = { path = "../egui/crates/egui" }' >> Cargo.toml
          echo 'egui_extras = { path = "../egui/crates/egui_extras" }' >> Cargo.toml

      - name: Grant execute permission to build script
        run: chmod +x tools/android/build.sh
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Fridgerator for Android
        run: |
          rustup target add aarch64-linux-android
          RELEASE=1 ./tools/android/build.sh

      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: |
            build/*.so
            build/sha256.json

  build-windows:
    runs-on: windows-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    steps:
      - uses: actions/checkout@v5
      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2

      - name: Setup and Patch Dependencies
        shell: powershell
        run: |
          pushd ..

          git clone --revision 44cdd653e2317d300fb8a6c9c36b03f23991e803 https://github.com/emilk/egui.git
          cd egui

          $File = "crates/egui/src/containers/combo_box.rs"
          (Get-Content $File) -replace 'ui.set_min_width\(ui.available_width\(\)\);', '// ui.set_min_width(ui.available_width());' | Set-Content $File

          cd ..

          git clone --revision 903043939a076dc81e122a1c8451755bfb3979c8 https://github.com/Nekomaru-PKU/egui-directx11.git
          cd egui-directx11

          $fxc = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Recurse -Filter "fxc.exe" | Where-Object { $_.FullName -like "*x64*" } | Select-Object -First 1
          if (-not $fxc) { Write-Error "fxc.exe not found"; exit 1 }

          & $fxc.FullName /nologo /O3 /T vs_4_0 /E vs_egui /Fo shaders/vs_egui.bin shaders/egui.hlsl
          & $fxc.FullName /nologo /O3 /T ps_4_0 /E ps_egui /Fo shaders/ps_egui.bin shaders/egui.hlsl

          popd

          $patches = @(
            "egui-directx11 = { path = '../egui-directx11' }",
            "egui = { path = '../egui/crates/egui' }",
            "egui_extras = { path = '../egui/crates/egui_extras' }"
          )
          Add-Content -Path "Cargo.toml" -Value $patches

      - uses: dtolnay/rust-toolchain@stable
      - name: Build Fridgerator for Windows
        run: |
          cargo build --target x86_64-pc-windows-msvc --target-dir build --release
          move build\x86_64-pc-windows-msvc\release\fridgerator.dll build

      - name: Build Cellar
        run: |
          git clone --depth 1 --revision d4c3f79801c8131e26df585766c35e5ce11ec57f https://github.com/Hachimi-Hachimi/Cellar
          cd Cellar
          cargo build --target x86_64-pc-windows-msvc --target-dir build --release
          move build\x86_64-pc-windows-msvc\release\cellar.dll build
          cd ..

      - name: Check out FunnyHoney
        run: git clone --depth 1 --revision 418b5348bd9b7376cc7485c591ca69d49aa4d805 https://codeberg.org/LeadRDRK/FunnyHoney.git

      - name: Build Installer
        run: |
          git clone --depth 1 https://github.com/HachiFridge/Installer
          copy build\fridgerator.dll Installer
          move Cellar\build\cellar.dll Installer
          move FunnyHoney\FunnyHoney.exe Installer
          cd Installer
          cargo build --target x86_64-pc-windows-msvc --target-dir build --release --features compress_bin
          cd ..
          move Installer\build\x86_64-pc-windows-msvc\release\fridgerator_installer.exe build

      - name: Get checksums for Windows binaries
        shell: bash
        run: |
          # Get the latest b3sum download URL from GitHub API
          DOWNLOAD_URL=$(curl -sL https://api.github.com/repos/BLAKE3-team/BLAKE3/releases/latest | \
            grep "browser_download_url.*b3sum_windows_x64_bin.exe" | \
            cut -d '"' -f 4)

          # Download b3sum
          curl -L "$DOWNLOAD_URL" -o b3sum.exe

          # Verify it's actually an executable, not an HTML error page
          if file b3sum.exe | grep -q "HTML"; then
            echo "Error: Downloaded file is HTML, not an executable"
            exit 1
          fi

          # Make it executable and calculate hashes
          chmod +x b3sum.exe
          DLL_HASH=($(./b3sum.exe build/fridgerator.dll | tr -d '\r'))
          EXE_HASH=($(./b3sum.exe build/fridgerator_installer.exe | tr -d '\r'))
          cat <<EOF > build/blake3.json
          {
            "fridgerator.dll": "$DLL_HASH",
            "fridgerator_installer.exe": "$EXE_HASH"
          }
          EOF

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            build/fridgerator.dll
            build/fridgerator_installer.exe

  create-release:
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Get release version
        id: get_info
        run: |
          VERSION=$(curl -sL "https://raw.githubusercontent.com/${{ github.repository }}/main/Cargo.toml" | \
            awk '/^\[package\]/{flag=1} flag && /^version/{print $3; exit}' | \
            tr -d '"')
          echo "RELEASE_VERSION=v$VERSION" >> $GITHUB_ENV

      - name: Download all build artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Create release notes
        run: |
          # Check if any tags exist in the repository
          TAG_COUNT=$(git tag --list | wc -l)

          if [ "$TAG_COUNT" -eq 0 ]; then
            # First release - no previous tags exist
            echo "## What's Changed" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is the first release of Fridgerator." >> CHANGELOG.md
            echo "" >> CHANGELOG.md

            # List all commits from the beginning
            COMMIT_HASHES=$(git rev-list --no-merges HEAD)
          else
            # Find the previous tag
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

            if [ -z "$PREVIOUS_TAG" ]; then
              # Fallback to initial commit if no tags found
              PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
            fi

            echo "## What's Changed" > CHANGELOG.md
            COMMIT_HASHES=$(git rev-list --no-merges ${PREVIOUS_TAG}..HEAD)
          fi

          IFS=$'\n'

          for hash in $COMMIT_HASHES; do
            subject=$(git show -s --format=%s $hash)
            body=$(git show -s --format=%b $hash)
            author_login=$(gh api "repos/${{ github.repository }}/commits/$hash" --jq '.author.login' 2>/dev/null || echo "")
            if [ -n "$author_login" ]; then
              author="$author_login"
            else
              author=$(git show -s --format=%an $hash)
            fi
            short_hash=$(git show -s --format=%h $hash)

            echo "* **$subject**" >> CHANGELOG.md

            if [ -n "$body" ]; then
              echo "$body" | while read -r line; do
                if [ -z "$line" ]; then continue; fi
                clean_line=$(echo "$line" | sed -E 's/^[ \t]*[-*+][ \t]*//')
                echo "    * $clean_line" >> CHANGELOG.md
              done
            fi
            echo "    (by @$author in $short_hash)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          done

          unset IFS
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload binaries to a release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG.md
          files: |
            artifacts/android/*
            artifacts/windows/*
          tag_name: ${{ env.RELEASE_VERSION }}
